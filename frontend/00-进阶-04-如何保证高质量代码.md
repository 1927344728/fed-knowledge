# 如何保证高质量代码 

通常项目中我们通过 `eslint` 和 `stylelint` 这些 lint 工具来检查代码的规范与否，保证良好的代码规范，从而在多人协作中保障项目质量和可维护性。正常我们会在提交代码前手动执行语法检查，而 `lint-staged` 和 `husky` 让这一过程自动化，在 `git` 的 `pre-commit` 阶段来检测你的代码，如果存在语法错误会中断 commit。



### [ESlint](http://eslint.cn)

ESLint 属于一种QA工具，是一个 `ECMAScript/JavaScript` 语法规则和代码风格的检查工具，可以用来保证写出语法正确、风格统一的代码。

ESLint 旨在完全可配置，它的目标是提供一个插件化的 Javascript 代码检测工具。这意味着您可以关闭每个规则，只能使用基本语法验证，或者混合并匹配捆绑的规则和自定义规则，使ESLint完美的适用于您的项目。

**安装：**`npm i eslint eslint-config-prettier eslint-plugin-prettier eslint-plugin-vue -D`

**配置：**`eslint --init`  // 运行后，会在当前目录下生成一个`.eslintrc`文件

**有两种主要的方法来配置ESLint：**

* **配置注释：**使用 JavaScript 注释将配置信息直接嵌入到文件中。格式如下：

  用注释指定全局变量：

  ```js
  /* global var1, var2 */
  ```

  指定变量不应被重写（只读），你可以将它们设置为 false：

  ```js
  /* global var1:false, var2:false */
  ```

  使用行注释禁用规则：

  ```js
  /* eslint-disable no-alert, no-console */
  alert('foo');
  console.log('bar');
  /* eslint-enable no-alert, no-console */
  ```

1. **ESLint配置文件：**使用下面任一的文件来为全部的目录和它的子目录指定配置信息

   * JavaScript： `.eslintrc.js` 
   * YAML： `.eslintrc.yaml` 或 `.eslintrc.yml` 
   * JSON： `.eslintrc.json` ，ESLint 的 JSON 文件允许 JavaScript 风格的注释。

   * **(不推荐)**  使用 `.eslintrc`，可以是 JSON ，也可以是 YAML。

   * package.json： `package.json` 中新增 `eslintConfig`属性，在那里定义配置数据。

   如果同一个目录下有多个配置文件，ESLint 只会使用一个。优先级顺序如下：

   1. `.eslintrc.js`

   2. `.eslintrc.yaml`

   3. `.eslintrc.yml`

   4. `.eslintrc.json`

   5. `.eslintrc`（已弃用）

   6. `package.json` 

默认情况下，ESLint 会在所有父级目录里寻找配置文件，一直到根目录。如果你想要你所有项目都遵循一个特定的约定时，这将会很有用，但有时候会导致意想不到的结果。为了将 ESLint 限制到一个特定的项目，在你项目根目录下的 `package.json` 文件或者 `.eslintrc.*` 文件里设置 `"root": true`。ESLint 一旦发现配置文件中有 `"root": true`，它就会停止在父级目录中寻找。

`.eslintrc.js`文件示例：[ESlint 中文官方网站](http://eslint.cn/)

```js
module.exports = {
    root: true,
    parser: "vue-eslint-parser",
    parserOptions: {
        parser: 'babel-eslint'
    },
    env: {
        browser: true,
    },
    globals: {},
    // https://github.com/feross/standard/blob/master/RULES.md#javascript-standard-style
    extends: ['plugin:vue/recommended', 'eslint:recommended'],
    rules: {
        "no-unused-vars": 0,
        "no-console": 0,
        'no-debugger': process.env.NODE_ENV === 'production' ? 2 : 0,
        'indent': [2, 2], //文件缩进
        "eqeqeq": 0, //严格比较 === 和 !==
        "no-useless-escape": 0, //无效转义符
        "quotes": [1, 'single'],  //单引号
        "semi": ["error", "never"], //名末分号
        "no-new": 0, //new 未赋值给一个变量
        "no-multiple-empty-lines": [1, { "max": 2, "maxEOF": 1 }], //最多空行、文件结尾最多空行
        "no-undef": 0,
        "no-empty": 0,
        "no-case-declarations": 0,

        "vue/max-attributes-per-line": [2, { //单行最多两个属性
            "singleline": 2,
            "multiline": {
                "max": 1,
                "allowFirstLine": false
            }
        }],
        "vue/require-v-for-key": 0,
        "vue/no-use-v-if-with-v-for": 0,
        "vue/require-default-prop": 0,
        "vue/no-unused-vars": 0,
        "vue/require-prop-types": 0,
        "vue/no-unused-components": 0,
        "vue/valid-v-on": 0,
        "vue/no-v-html": 0,
        "vue/require-component-is": 0,
        "vue/valid-v-for": 0,
        "vue/no-parsing-error": 0,
        "vue/no-async-in-computed-properties": 0,
        "vue/no-side-effects-in-computed-properties": 0,
        "vue/valid-v-bind": 0
    }
}
```

**Eslint使用：**

* 命令行：`eslint --fix '{src,packages}/**/*.{js,vue,ts}'`

* webpack.config.js：

  ```js
  {
      module: {
          rules: [
              {
                  test: /\.(js|vue)$/,
                  loader: 'eslint-loader',
                  enforce: "pre",
                  include: [resolve('src'), resolve('packages')],
                  options: {
                      formatter: require('eslint-friendly-formatter'),
                      fix: true
                  }
              }
          ]
      }
  }
  ```

* 忽略文件：新增`eslintignore`文件，加上需要忽略的路径：

  ```sh
  docs/**
  ```

  

### [Stylelint](https://www.npmjs.com/package/stylelint)

一个强大的css校验插件，可以帮助你避免错误和强制约定一些代码风格

**安装：**`npm i stylelint stylelint-config-standard stylelint-selector-bem-pattern -D`

**配置：**代码检查工具需要一个配置对象。您可以制作自己的配置或继承现有配置。 查找和加载配置对象从当前工作目录开始，它将按以下顺序查找以下可能的源：

- `package.json` 中的 `stylelint` 属性
- `.stylelintrc` 文件
-  `stylelint.config.js` 文件

`.stylelintrc` 文件（没有扩展名）可以是 JSON 或 YAML 格式。或者您可以添加文件扩展名以指定格式：`.stylelintrc.json`、 `.stylelintrc.yaml`、 `.stylelintrc.yml`、 `.stylelintrc.js`。

找到并解析其中一个后，搜索将停止并将使用该对象。可以使用 `config` 或 `configFile` 选项绕过配置搜索。

`stylelint.config.js`文件示例：[stylelint配置](https://stylelint.docschina.org/user-guide/configuration/)

```js
{
	"extends": "stylelint-config-standard",
	"plugins": [
		"stylelint-selector-bem-pattern"
	],
	"rules": {
		"block-no-empty": null,
		"color-no-invalid-hex": true,
		"comment-empty-line-before": [ "always", {
			"ignore": ["stylelint-commands", "after-comment"]
		}
		],
		"declaration-colon-space-after": "always",
		"indentation": ["tab", {
			"except": ["value"]
		}],
		"max-empty-lines": 2,
		"rule-empty-line-before": [ "always", {
			"except": ["first-nested"],
			"ignore": ["after-comment"]
		}
		],
		"unit-whitelist": ["em", "rem", "%", "s"],
		"plugin/selector-bem-pattern": {
			componentSelectors: function (componentName) {
				var word = '[a-z0-9]+';
				var namespace = `bx-tool`;
				var block = `(?:-${word})+`;
				var elementOrModifier = `(?:-|--${word})*`;
				return new RegExp(`^\\.${namespace}${block}${elementOrModifier}`);
			},
			implicitComponents: "packages/**/*.css",
			ignoreSelectors: [
				'\.img-responsive',
				'\.animate-.+$',
				'\.transition-.+$',
			]
		}
	}
}
```

`stylelint-selector-bem-pattern`，是`stylelint`的扩展插件，为css选择器指定正则匹配。

**Eslint使用：**

- 命令行：`stylelint --cache **/*.{html,vue,css,sass,scss} --fix`

- 各种编辑器：`Sublime Text、Atom、Visual Studio Code`等

- 各种构建工具：Gulp、Webpack等

- 通过 Node.js 的api

- 作为 postcss 的插件




### [Husky](<https://www.npmjs.com/package/husky>)

现在最流行的版本管理工具非`git`莫属，而良好的代码规范有助于项目的维护，为了防止一些不规范的代码  `commit`并`push`到远端,我们可以在`git`命令执行前用一些钩子来检测并阻止。现在大前端主要有两种`git`钩子插件：`husky`（jquery与next.js都在用），`pre-commit`(antd在用) 。husky能够防止不规范代码被commit、push、merge等等。 

安装：` npm i husky -D`

```js
//package.json
{
	"scripts": {
		"precommit": "lint-staged"
	}
}
```

 

###  [Lint-staged](https://github.com/okonet/lint-staged)

 [lint-staged](https://github.com/okonet/lint-staged)可以在`git staged`阶段的文件上执行`linters`，简单点来说就是当我们运行`eslint`或`stylelint`的命令时，只会检查我们通过`git add`添加到暂存区的文件，可以避免我们每次检查都把整个项目的代码都检查一遍。

 安装：`npm i lint-staged -D`

```js
//package.json
{
    "scripts": {
        "precommit": "lint-staged"
    },
    "lint-staged": {
        "{src,packages}/**/*.{js,vue}": [
            "eslint --fix",
            "prettier --write",
            "git add"
        ],
        "{src,packages}/**/*.{css,vue}": [
            "stylelint --fix",
            "git add"
        ]
    }
}
```

 

### Prettier

Prettier工具主要用来统一代码格式的，eslint 也会对代码进行一定程度的格式校验，但主要是用来对代码规范的扫描，而 prettier 则是专门用来对代码进行格式化，两个工具各司其职，为代码质量进行保驾护航。它的主要原理是**将格式化前的代码和格式化后的代码进行比对，如果发现不一样，prettier就会对其进行标记并按照指定的格式化规范进行修复**。

**安装：**`npm i prettier eslint-plugin-prettier eslint-config-prettier -D `

**配置：**

1. `.prettierrc` 文件
2. `prettier.config.js `文件
3. `package.json` 中配置`prettier`属性

```js
//prettier.config.js
module.exports = {
    printWidth: 80,
    semi: true,
    singleQuote: true,
    trailingComma: 'none',
    bracketSpacing: true,
    jsxBracketSameLine: false,
    arrowParens: 'avoid',
    requirePragma: false,
    proseWrap: 'preserve'
}
```

为了和`eslint`配合使用需要引入两个插件`eslint-plugin-prettier和eslint-config-prettier`，其中需要说明的是 `eslint-config-prettier` 插件的作用，这个插件是如果 `eslint `的规则和 `prettier `的规则发生冲突的时候（主要是不必要的冲突），例如`eslint `限制了必须单引号，`prettier`也限制了必须单引号，那么如果用 `eslint `驱动 `prettier `来做代码检查的话，就会提示2种报错，虽然他们都指向同一种代码错误，这个时候就会由这个插件来关闭掉额外的报错。

 

### 钩子工作流程

当开发者执行 `git add` 操作将代码提交到暂存区后，再执行 `git commit` 操作：

1. 由于安装`husky`后，其在`.git/hooks`中写入了`pre-commit`钩子，该钩子在 `git commit` 执行时被触发，执行`npm run precommit`脚本（即`lint-staged`命令）；
2.  `lint-staged`的配置，就是利用`linters`对暂存区的文件路径应用过滤规则，匹配的文件将执行后面配置的任务，这里的任务就是调用项目中的`eslint`指令检查文件，如果报错则先自动修复`--fix`，最后把没有问题的代码加入暂存区`git add`。
3. 如果最终还有报错，则流程终止，无法执行 commit 操作。

 

### 参考链接

[eslint+husky+prettier+lint-staged提升前端应用质量](<https://juejin.im/post/5c67fcaae51d457fcb4078c9#heading-8>)

[使用husky、lint-staged、prettier、eslint保持团队代码一致](https://www.imqianduan.com/tool/171.html)

[深入浅出eslint——关于我学习eslint的心得](https://juejin.im/post/5bab946cf265da0ae92a75ca)

[自定义规则](https://www.jianshu.com/p/1c805c52c51d)

[高级前端基础-JavaScript抽象语法树AST](https://segmentfault.com/a/1190000018532745)



 

 

 

 

 

 

