<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
	<title>Promise</title>
</head>
<body>
<style>
    .flex_box {
        padding: 10px 0;
        text-align: center;
    }
</style>
<style>
    .flex_item {
    }
</style>
<section>
    <div class="flex_box">
      <div>
        <h3>postMessage 通信</h3>
        <p>这是一个不同源的iframe元素</p>
      </div>
      <iframe id="myIframe" src="http://192.168.2.103:3000/17-input.html" style="border: 0;" onload="wPostMessage()"></iframe>
      <div>
        <span style="display: inline-block; padding: 5px 30px; background: #0aa; border-radius: 10px; color: #fff;" onclick="wPostMessage()">随机色值</span>
      </div>
    </div>
</section>
<script type="text/javascript">

</script>

<script src="./utils.js"></script>
<script type="text/javascript">
    function wPostMessage () {
      window.frames[0].postMessage(`#${Math.round(Math.random() * 16).toString(16)}${Math.round(Math.random() * 16).toString(16)}${Math.round(Math.random() * 16).toString(16)}`, 'http://192.168.2.103:3000/17-input.html')
    }

    let type = null
    function loadImageAsync(url) {
      return new Promise(function(resolve, reject) {
        const image = new Image()
        image.onload = function() {
          resolve(image)
        }
        image.onerror = function() {
          reject(new Error(`加载出错： ${url}`))
        }
        image.src = url
      })
    }
    const getText = function(url) {
      return new Promise((resolve, reject) => {
        const handler = function() {
          if (this.readyState !== 4) {
            return
          }
          if (this.status === 200) {
            return resolve(this.response)
          } else {
            return reject(new Error(this.statusText))
          }
        }
        const http = new XMLHttpRequest()
        http.open("GET", url)
        http.onreadystatechange = handler
        http.send()
      })
    }

    const func1 = () => new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('func1')
            resolve('func1')
        }, 2000)
    })
    const func2 = () => new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('func2')
            resolve('func2')
        }, 1000)
    })
    const func3 = () => new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('func3')
            resolve('func3')
        }, 1000)
    })


    // function sequencePromises (promises) {
    //   function recordValue(results, value) {
    //       results.push(value)
    //       return results
    //   }
    //   // 记录每个Promise实例的执行结果。如果不调用此方法，函数最后的Promise的传递出来的参数，只有最后一个Promise实例的执行结果
    //   let pushValue = recordValue.bind(null, [])
    //   let promise = Promise.resolve()
    //   for (let i = 0; i < promises.length; i++) {
    //       promise = promise.then(promises[i]).then(pushValue)
    //   }
    //   return promise
    // }
    // function sequencePromises (promises) {
    //   function recordValue(results, value) {
    //       results.push(value)
    //       return results
    //   }
    //   // 记录每个Promise实例的执行结果。如果不调用此方法，函数最后的Promise的传递出来的参数，只有最后一个Promise实例的执行结果
    //   let pushValue = recordValue.bind(null, [])
    //   return promises.reduce((promise, task) => {
    //     return promise.then(task).then(pushValue)
    //   }, Promise.resolve())
    // }
    async function sequencePromises (promises) {
      let result
      for (let f of [func1, func2, func3]) {
          result = await f(result)
      }
      return result
    }

    let callback = function () {
      // loadImageAsync('./img/pins_3338674420.jpg').then(res => {
      //   console.log('加载成功！')
      // }, err => {
      //   console.log(err.message)
      // })
      // loadImageAsync('./img/pins_3338674420.jpg').then(res => {
      //     console.log('加载成功！')
      // }).catch( err => {
      //     console.log(err.message)
      // })

      // getText("./assets/%E7%BE%8E%E4%BA%BA%E8%B0%B7%20-%20%E9%98%BF%E5%85%B0.vtt").then(json => {
      //   console.log('Contents: ' + json)
      // }, error => {
      //   console.error('出错了', error)
      // })

      // Promise.all([func1(), func2(), func3()]).then(res => {
      //   console.log('参数：', res)
      // })

      // Promise.resolve().then(func1).then(func2).then(func3).then(res => {
      //   console.log('参数：', res)
      // })

      // sequencePromises([func1, func2, func3]).then(res => {
      //     console.log('参数：', res)
      // })

      // sequencePromises()
    }
    if (
        document.readyState === "complete" ||
        (document.readyState !== "loading" && !document.documentElement.doScroll)
    ) {
        callback()
    } else {
        document.addEventListener("DOMContentLoaded", callback)
    } 
</script>
</body>
</html>
